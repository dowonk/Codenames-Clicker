(async () => {
  const delay = ms => new Promise(res => setTimeout(res, ms));

  /* ============================
     COLLECT & SORT CARDS
     ============================ */

  const cards = Array.from(document.querySelectorAll('div[role="img"]'))
    .filter(card => card.hasAttribute('tabindex'))
    .sort((a, b) =>
      parseInt(a.getAttribute('tabindex'), 10) -
      parseInt(b.getAttribute('tabindex'), 10)
    )
    .slice(0, 25);

  const cardsByTab = cards.reduce((map, card) => {
    map[parseInt(card.getAttribute('tabindex'), 10)] = card;
    return map;
  }, {});

  /* ============================
     INITIAL SPIRAL SWIRL
     (MAX 3 ACTIVE, 50ms DELAY)
     ============================ */

  const size = 5;
  const spiral = [];

  let top = 0, bottom = size - 1;
  let left = 0, right = size - 1;

  while (top <= bottom && left <= right) {
    for (let c = left; c <= right; c++) spiral.push(top * size + c);
    top++;

    for (let r = top; r <= bottom; r++) spiral.push(r * size + right);
    right--;

    if (top <= bottom) {
      for (let c = right; c >= left; c--) spiral.push(bottom * size + c);
      bottom--;
    }

    if (left <= right) {
      for (let r = bottom; r >= top; r--) spiral.push(r * size + left);
      left++;
    }
  }

  const active = [];

  for (const tab of spiral) {
    const target = cardsByTab[tab]?.querySelector('.cardImage');
    if (!target) continue;

    target.click();
    active.push(target);
    await delay(50);

    if (active.length > 3) {
      const old = active.shift();
      old.click();
      await delay(50);
    }
  }

  // Clear all at center
  for (const target of active) {
    target.click();
    await delay(50);
  }

  /* ============================
     DRAW X
     ============================ */

  const xTabs = [0, 4, 6, 8, 12, 16, 18, 20, 24];

  for (const tab of xTabs) {
    const target = cardsByTab[tab]?.querySelector('.cardImage');
    if (!target) continue;
    target.click();
  }

  await delay(1000);

  for (const tab of xTabs) {
    const target = cardsByTab[tab]?.querySelector('.cardImage');
    if (!target) continue;
    target.click();
  }

  /* ============================
     DRAW OUTER BORDER
     ============================ */

  const borderTabs = [
    0, 1, 2, 3, 4,
    5, 9,
    10, 14,
    15, 19,
    20, 21, 22, 23, 24
  ];

  for (const tab of borderTabs) {
    const target = cardsByTab[tab]?.querySelector('.cardImage');
    if (!target) continue;
    target.click();
  }

  await delay(1000);

  for (const tab of borderTabs) {
    const target = cardsByTab[tab]?.querySelector('.cardImage');
    if (!target) continue;
    target.click();
  }
})();
